#!/usr/bin/env nix-shell
#!nix-shell -i bash -p bubblewrap opencode

set -euo pipefail

PWD_REAL="$(pwd -P)"

CFG_DIR="${HOME}/.config/opencode"

XDG_CONFIG_HOME="${HOME}/.config"
XDG_DATA_HOME="${HOME}/.local/share"
XDG_CACHE_HOME="${HOME}/.cache"
XDG_STATE_HOME="${HOME}/.local/state"

mkdir -p \
  "${CFG_DIR}" \
  "${XDG_DATA_HOME}" \
  "${XDG_CACHE_HOME}" \
  "${XDG_STATE_HOME}"

args=(
  --unshare-all
  --share-net
  --die-with-parent
  --new-session
  --hostname opencode-sandbox
  --ro-bind /proc /proc
  --tmpfs /dev
  --dev-bind /dev/null /dev/null
  --dev-bind /dev/zero /dev/zero
  --dev-bind /dev/random /dev/random
  --dev-bind /dev/urandom /dev/urandom
  --tmpfs /tmp

  --tmpfs "${HOME}"
  --dir "${HOME}/.config"
  --dir "${HOME}/.local"
  --dir "${HOME}/.cache"

  --ro-bind "${CFG_DIR}" "${CFG_DIR}"
  --bind "${XDG_DATA_HOME}"  "${XDG_DATA_HOME}"
  --bind "${XDG_CACHE_HOME}" "${XDG_CACHE_HOME}"
  --bind "${XDG_STATE_HOME}" "${XDG_STATE_HOME}"

  --bind "${PWD_REAL}" /work
  --chdir /work

  --setenv HOME "${HOME}"
  --setenv XDG_CONFIG_HOME "${XDG_CONFIG_HOME}"
  --setenv XDG_DATA_HOME "${XDG_DATA_HOME}"
  --setenv XDG_CACHE_HOME "${XDG_CACHE_HOME}"
  --setenv XDG_STATE_HOME "${XDG_STATE_HOME}"
)

# Bind common FHS paths if they exist (non-Nix or partially-FHS systems)
for p in /usr /bin /sbin /lib /lib64; do
  if [ -e "$p" ]; then
    args+=( --ro-bind "$p" "$p" )
  fi
done

# Nix: expose the store so dynamically linked programs run
if [ -e /nix/store ]; then
  args+=( --ro-bind /nix /nix )
fi

# Name resolution / TLS (often needed if networking is enabled)
for p in /etc/resolv.conf /etc/hosts /etc/ssl /etc/ca-certificates; do
  if [ -e "$p" ]; then
    args+=( --ro-bind "$p" "$p" )
  fi
done

exec bwrap "${args[@]}" opencode "$@"
